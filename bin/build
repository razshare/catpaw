#!/usr/bin/env php
<?php
use Amp\Promise;
use CatPaw\Environment\Attributes\Environment;
use CatPaw\Environment\Attributes\EnvironmentFileName;

use function Amp\File\createDirectory;
use function Amp\File\deleteFile;
use function Amp\File\exists;
use function Amp\File\isFile;
use function Amp\File\write;
use function CatPaw\deleteDirectoryRecursively;
use function CatPaw\listFilesRecursively;

/**
 * 
 * @return Generator<int, Promise<bool>|Promise<void>, mixed, void> 
 * @throws Error 
 */
#[EnvironmentFileName("build.yml")]
function main(
    #[Environment("name")] string $name,
    #[Environment("entry")] string $entry,
    #[Environment("library")] string $library,
    #[Environment("ignore")] ?array $ignore = [],
){
    $name = str_replace(['"',"\n"], ['\\"',''], $name);
    $entry = realpath(str_replace(['"',"\n"], ['\\"',''], $entry));
    $library = realpath(str_replace(['"',"\n"], ['\\"',''], $library));
    
    // $project = '.';
    $app = 'dist/app.phar';
    $start = 'dist/start';
    try {

        if(yield exists('dist')){
            yield deleteDirectoryRecursively('dist');
        }

        yield createDirectory('dist');

        yield write($start,<<<PHP
        <?php
        use Amp\File\Filesystem;
        use Amp\Loop;
        use CatPaw\Amp\File\CatPawDriver;
        use CatPaw\Bootstrap;
        \$_ENV = [
            ...\$_ENV,
            ...getenv(),
        ];
        require 'vendor/autoload.php';

        if (isset(\$_ENV["CATPAW_FILE_DRIVER"]) && \$_ENV["CATPAW_FILE_DRIVER"]) {
            Loop::setState(\Amp\File\Driver::class, new Filesystem(new CatPawDriver));
        }
        Bootstrap::start(
            entry: "$entry",
            name: "$name",
            library: "$library",
            info: false,
            dieOnChange: false,
            resources: '',
        );
        PHP);

        if (yield exists($app)) {
            yield deleteFile($app);
        }

        if (yield exists($app . '.gz')) {
            yield deleteFile($app . '.gz');
        }
        
        $phar = new Phar($app);

        $phar->startBuffering();

        $phar->buildFromDirectory('.');

        $directories = [];

        foreach(yield listFilesRecursively('.', $ignore) as $filename){
            do {
                $pieces  = explode(DIRECTORY_SEPARATOR,$filename);
                $count = count($pieces);
                if($count <= 2){
                    break;
                }
                $filename = join(DIRECTORY_SEPARATOR,array_slice($pieces,0,$count-1));
            } while(true);


            if(yield isFile($filename)) {
                $phar->addFile($filename);
            } else {
                $directories[$filename] = false;
            }
        }

        $phar->setStub(
            '#!/usr/bin/env php'
            .PHP_EOL
            .$phar->createDefaultStub($start)
        );

        $phar->setDefaultStub($start);

        $phar->stopBuffering();

        $phar->compressFiles(Phar::GZ);

        # Make the file executable
        chmod($app, 0770);

        yield deleteFile($start);

        echo "$app successfully created" . PHP_EOL;
    } catch (Exception $e) {
        die(((string)$e).PHP_EOL);
    }
}