# Goffi

Invoke _Go_ functions from _Php_.

> [!CAUTION]
> This feature is experimental.


# Usage

> [!NOTE]
> You will need [Go](https://go.dev/) installed on your machine.

Write your _Go_ program, for example in a `goffi.go` file.

```go
// ./goffi.go
package main
import "C"
func main() {}

//export DoubleIt
func DoubleIt(x int) int {
return x * 2
}
```

The `//export DoubleIt` annotation will make it so that the function `DoubleIt()` will be exposed.

Compile your program to a shared object
```sh
go build -o libgoffi.so -buildmode=c-shared goffi.go
```
This will create 2 files, your shared object `libgoffi.so` and its C header file `libgoffi.h`.

Resolve the C header file's preprocessor directives.
```sh
cpp -P ./libgoffi.h ./libgoffi.static.h
```
This will create a `libgoffi.static.h` file, this file _must_ be located in the same directory as the `libgoffi.so` file.

Now use `goffi()` to interop with your _Go_ program from _Php_.

```php
<?php
// src/main.php
use function CatPaw\Core\goffi;

 interface Goffi {
     function DoubleIt(int $value);
 }

function main(){

 $lib = goffi(Goffi::class, './libgoffi.so')->try($error);
 if($error){
     return error($error);
 }

 $doubled = $lib->DoubleIt(3);
 echo "doubled: $doubled\n";
}
```

Run the program.

```sh
composer prod:start
```

It should print

```sh
doubled: 6
```

# Usage with strings

Given the following Go program

```go
package main

import "C"

func main() {}

//export Greeting
func Greeting(name string) {
    println("hello " + name)
}
```
Call _Greeting_ from php like so

```php
<?php
use function CatPaw\Core\anyError;
use function CatPaw\Core\goffi;
use CatPaw\Core\Unsafe;

interface Goffi {
    function Greeting($name);
}

function main():Unsafe {
    return anyError(function() {
        $goffi = goffi(Goffi::class, './libgoffi.so')->try($error)
        or yield $error;

        $struct    = $goffi->new('_GoString_');
        $struct->p = $goffi->new('char[5]', 0);

        FFI::memcpy($struct->p, 'world', 5);
        $struct->n = 5;



        $goffi->Greeting($struct);
    });
}
```

Run it with
```sh
composer prod:start
```
it should print `hello world` to the terminal.


# Other notes

> [!NOTE]
> More quality of life improvements will come in the future.\
> I'm pretty sure every single one of the steps above can be automatized allowing for a straight forward api,
> maybe just the interface declaration on the php side of things will remain.\
> \
> Discussion available [here](https://github.com/tncrazvan/catpaw/discussions/3).
