This feature requires the package `catpaw/web`, which can be installed using<br/>

```
composer require catpaw/web
```

<hr/>

# Web Byte Range Requests

Byte range requests are supported out of the box in the default `@404` handlers.<br/>
That being said, the feature is packed into one service called `CatPaw\Services\ByteRangeService`, which you can use to
serve your own requests manually.<br/>

## ByteRangeService

Here's a simple example of how you would use the service:

```php
use CatPaw\Web\Attributes\Param;
use CatPaw\Web\Services\ByteRangeService;

function main(){
    $server = Server::create();
    $server->router->get(
        path: "/{filename}",
        callback: function(
            #[Param] string $filename,
            #[Header("range")] false|array $range,
            ByteRangeService $service
        ){
            return $service->response(
                    rangeQuery: $range[0]??"",
                    headers   : [
                                    "Content-Type"   => "text/html",
                                    "Content-Length" => \Amp\File\getSize($filename),
                                ],
                    writer    : new class($filename) implements ByteRangeWriterInterface {
                                    private File $file;

                                    public function __construct(private string $filename) { }

                                    public function start():void {
                                        $this->file = openFile($this->filename, "r");
                                    }


                                    public function data(callable $emit, int $start, int $length):void {
                                        $this->file->seek($start);
                                        $data = $this->file->read($length);
                                        $emit($data);
                                    }


                                    public function end():void {
                                        $this->file->close();
                                    }
                                }
                );
        } 
    );
    $srver->start();
}
```

Your endpoint will now serve bye range requests, but it will also throw an exception if the request is not a byte range
request or if the requested range is invalid.<br/>
In those cases you can catch the exception and resume to a normal file buffering.<br/>

```php
use CatPaw\Web\Attributes\Header;
use CatPaw\Web\Attributes\Param;
use CatPaw\Web\Services\ByteRangeService;
use function CatPaw\duplex;
use Amp\Http\HttpStatus;
use function Amp\File\getSize;
use Amp\File\File;

function main(){
    $server = Server::create();
    $server->router->get(
        path: "/{fileName}",
        callback: function(
            #[Param] string $fileName,
            #[Header("range")] false|array $range,
            ByteRangeService $service
        ){
            try {
                return $service->response(
                    rangeQuery: $range[0]??"",
                    headers   : [
                                    "content-type"   => "text/html",
                                    "content-length" => getSize($fileName),
                                ],
                    writer    : new class($fileName) implements ByteRangeWriterInterface {
                                    private File $file;

                                    public function __construct(private string $fileName) { }

                                    public function start(): void {
                                        $this->file = openFile($this->fileName, "r");
                                    }


                                    public function data(callable $emit, int $start, int $length): void {
                                        $this->file->seek($start);
                                        $data = $this->file->read($length);
                                        $emit($data);
                                    }


                                    public function end(): void {
                                        $this->file->close();
                                    }
                                }
                );
            } catch(InvalidByteRangeQueryException) {
                [$reader,$writer] = duplex(65536);
                $file             = openFile($fileName, 'r');

                async(function() use ($file, $writer) {
                    while ($data = $file->read()) {
                        $writer->write($data);
                    }
                    $file->close();
                });
                
                return new Response(
                    status: HttpStatus::OK,
                    headers: [
                        "accept-ranges"  => "bytes",    // let the client know we can serve byte-range requests
                        "content-type"   => "text/html",
                        "content-length" => $length,
                    ],
                    body: $reader,
                );
            }
        } 
    );
    $server->start();
}
```

Note that we're still letting the client know that we can serve byte range request by setting the `accpet-ranges: bytes`
header.
